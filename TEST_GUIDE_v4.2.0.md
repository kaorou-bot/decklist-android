# v4.2.0 测试指南

> 版本：v4.2.0
> 分支：dev/v4.2.0
> 日期：2026-02-06

---

## 📋 测试前准备

### 1. 安装应用

```bash
# 构建 Debug APK
./gradlew assembleDebug

# 或者构建 Release APK
./gradlew assembleRelease

# 安装到设备
adb install app/build/outputs/apk/debug/app-debug.apk
```

### 2. 确保设备连接
```bash
adb devices
```

---

## 🧪 测试项目

### 测试 1：套牌下载验证逻辑

**目的：** 验证套牌下载不会混入其他赛事的套牌

**步骤：**

1. 打开应用，进入"赛事"页面
2. 选择"Vintage"赛制
3. 找到 2026年2月1日的赛事
4. 点击"下载套牌"
5. 等待下载完成

**预期结果：**
- ✅ 只下载属于该赛事的套牌
- ✅ 没有其他赛制（如 Pauper）的套牌混入
- ✅ 套牌数量正确

**验证代码逻辑：**
- `MtgTop8Scraper.kt` - 第1286-1315行
- 从套牌 URL 提取赛事 ID 和赛制代码
- 构造标准赛事 URL 进行精确匹配

**代码说明：**
```kotlin
// 策略1: 从 deck URL 本身提取赛事 ID
// URL 格式: https://mtgtop8.com/?e=EVENT_ID&d=DECK_ID&f=FORMAT
val eventPattern = Regex("[?&]e=(\\d+)")
val eventMatch = eventPattern.find(deckUrl)
if (eventMatch != null) {
    val eventId = eventMatch.groupValues[1]
    // 构造标准赛事 URL
    val eventUrl = "https://mtgtop8.com/event?e=$eventId$format"
    return@withContext eventUrl
}
```

---

### 测试 2：套牌分析功能

**目的：** 验证套牌分析功能正常工作，图表显示正确

**步骤：**

1. 打开任意套牌详情
2. 点击右上角菜单 → "套牌分析"
3. 查看三个标签页：
   - 法术力曲线
   - 颜色分布
   - 类型分布
4. 测试"按数量"/"按牌名"切换按钮

**预期结果：**

#### 法术力曲线（柱状图）
- ✅ X轴显示法术力值（0, 1, 2, 3, 4, 5, 6, 7+）
- ✅ Y轴显示卡牌数量
- ✅ 数据准确：例如 4张"蓝色法术力飞瀑"应显示在 CMC=3 的位置
- ✅ 非地平均法术力值正确显示

**测试数据示例：**
- "蓝色法术力飞瀑" (3u) → CMC = 4
- "黑土从林" (r) → CMC = 1（但不算入平均法术力，因为是地牌）
- "烁光荒原" (1ur) → CMC = 3

#### 颜色分布（饼图）
- ✅ 显示各颜色卡牌数量
- ✅ 多色卡牌为金色 (#FFD700)
- ✅ 单色卡牌：白色、蓝色、黑色、红色、绿色
- ✅ 无色卡牌单独显示
- ✅ 数据统计准确

**关键修复：**
- 多色卡牌单独统计（MULTICOLOR 类别）
- 不再重复计入多个颜色

#### 类型分布（柱状图）
- ✅ X轴显示卡牌类型
- ✅ Y轴显示数量
- ✅ 类型名称显示正确（"地"而不是"地陆"）
- ✅ 数据统计准确

**支持的类型：**
- 生物 (Creature)
- 瞬间 (Instant)
- 法术 (Sorcery)
- 神器 (Artifact)
- 结界 (Enchantment)
- 鹏洛客 (Planeswalker)
- 地 (Land)
- 其他 (Other)

#### 统计摘要
- ✅ 主牌数 = 所有主牌数量总和
- ✅ 备牌数 = 所有备牌数量总和
- ✅ 非地平均法术力 = 非地牌法术力平均值
- ✅ 地牌数量正确

#### 双模式统计
- ✅ 切换按钮"按数量"/"按牌名"正常工作
- ✅ "按数量"：4张同名牌计为4
- ✅ "按牌名"：4张同名牌计为1

---

### 测试 3：数据准确性验证

**目的：** 验证所有统计数据准确无误

#### 测试套牌示例：奥扎奇红绿风暴

1. **主牌数验证**
   - 打开套牌详情，统计所有主牌数量
   - 在套牌分析中查看主牌数
   - 应该一致

2. **地牌数量验证**
   - 统计套牌中所有地牌（包括4张同名牌）
   - 在套牌分析中查看地牌数量
   - 应该一致

3. **非地平均法术力验证**
   - 手动计算：(所有非地牌法术力值 × 数量) / 非地牌总数
   - 与套牌分析中的数值对比
   - 误差应在 ±0.01 范围内

4. **法术力曲线验证**
   - 选择几张代表性卡牌：
     - "蓝色法术力飞瀑" (3u) → CMC=4
     - "树林" → CMC=0（地牌）
     - "博弈巨像" (8) → CMC=8（显示为7+）
   - 验证这些牌出现在正确的法术力值位置

5. **颜色分布验证**
   - 统计各颜色卡牌数量
   - 验证多色卡牌计入"多色"类别（金色）
   - 验证单色卡牌计入对应颜色

---

## 🐛 已知问题和修复

### 修复 1：法术力值计算错误
- **问题：** 只提取数字，忽略花色符号
- **修复：** 正确实现 CMC 计算（5u=6, r=1, 1ur=3）
- **文件：** `DeckAnalyzer.kt` 第317-353行

### 修复 2：类型分布图表错乱
- **问题：** BarEntry 参数顺序错误 + HorizontalBarChart
- **修复：** 改为标准 BarChart（X轴类别，Y轴数量）
- **文件：** `TypeDistributionFragment.kt`

### 修复 3：颜色分布总和不对
- **问题：** 多色卡牌被计入多个颜色
- **修复：** 添加 MULTICOLOR 类别单独统计
- **文件：** `DeckAnalyzer.kt` 第139-198行

### 修复 4：多色颜色
- **问题：** 紫色不太合适
- **修复：** 改为金色 #FFD700
- **文件：** `ColorDistributionFragment.kt`

### 修复 5：非地平均法术力
- **问题：** 地牌数量只统计种类数
- **修复：** 使用 sumOf 统计实际数量
- **文件：** `DeckAnalyzer.kt` 第250-307行

### 修复 6：类型名称
- **问题：** "地陆" 不对
- **修复：** 改为"地"
- **文件：** `CardType` 枚举

### 修复 7：套牌下载混入其他赛事
- **问题：** Standard 赛事出现 Commander 套牌，Vintage 赛事出现 Pauper 套牌
- **原因：** MTGTop8 的 deck ID 全局递增
- **修复：** 从 deck URL 提取赛事 ID，构造赛事 URL，精确匹配
- **文件：** `MtgTop8Scraper.kt` 第1283-1315行

---

## 📊 测试检查清单

### 套牌下载
- [ ] Vintage 赛事只下载 Vintage 套牌
- [ ] Standard 赛事只下载 Standard 套牌
- [ ] Modern 赛事只下载 Modern 套牌
- [ ] 没有其他赛制的套牌混入

### 法术力曲线
- [ ] 图表显示正常（柱状图）
- [ ] CMC 计算正确（3u=4, r=1, 1ur=3）
- [ ] 非地平均法术力正确
- [ ] 0法术力显示正确（地牌）
- [ ] 7+法术力合并显示正确

### 颜色分布
- [ ] 图表显示正常（饼图）
- [ ] 多色为金色
- [ ] 单色分别为白蓝黑红绿
- [ ] 无色单独显示
- [ ] 数量统计正确

### 类型分布
- [ ] 图表显示正常（柱状图）
- [ ] 类型名称正确（"地"）
- [ ] 数量统计正确

### 双模式统计
- [ ] "按数量"正常工作
- [ ] "按牌名"正常工作
- [ ] 切换后图表正确更新

---

## 📝 测试报告模板

完成测试后，请填写以下报告：

```markdown
### v4.2.0 测试报告

**测试日期：** YYYY-MM-DD
**测试设备：** [设备型号]
**Android 版本：** [版本]

#### 测试结果

1. **套牌下载验证**
   - 结果：✅ 通过 / ❌ 失败
   - 备注：[说明]

2. **法术力曲线**
   - 结果：✅ 通过 / ❌ 失败
   - 备注：[说明]

3. **颜色分布**
   - 结果：✅ 通过 / ❌ 失败
   - 备注：[说明]

4. **类型分布**
   - 结果：✅ 通过 / ❌ 失败
   - 备注：[说明]

5. **双模式统计**
   - 结果：✅ 通过 / ❌ 失败
   - 备注：[说明]

#### 发现的问题
1. [问题描述]
2. [问题描述]

#### 总体评价
- [ ] 可以发布
- [ ] 需要修复
```

---

## 🔧 调试技巧

### 查看日志
```bash
# 实时查看 DeckAnalyzer 日志
adb logcat | grep "DeckAnalyzer"

# 查看 MtgTop8Scraper 日志
adb logcat | grep "MtgTop8Scraper"
```

### 清除数据重新测试
```bash
# 清除应用数据
adb shell pm clear com.mtgo.decklistmanager

# 或在设置中：应用 → MTGO Decklist Manager → 存储 → 清除数据
```

---

**创建时间：** 2026-02-06
**下次更新：** 测试完成后
