# 性能优化和问题修复报告

**日期**: 2025-02-19
**版本**: v5.1.0

---

## ✅ 已完成的修复

### 1. 性能优化 - 印刷版本查询超时控制

**问题**: 打开几张牌后应用变得特别卡

**根本原因**:
- 印刷版本查询耗时可能超过 20 秒
- 每次打开卡牌详情都会自动查询印刷版本
- 中文名称查询服务器会超时

**优化措施**:
- 添加 5 秒超时控制 (`withTimeout(5000)`)
- 禁用自动查询：对于没有 `oracleId` 的卡牌，不再自动查询印刷版本
- 修复智能转换编译错误

**文件修改**:
- `CardInfoFragment.kt`:
  - 添加 `withTimeout(5000)` 超时控制
  - 移除中文名称的自动搜索回退
  - 只对有 `oracleId` 的卡牌自动加载印刷版本

---

## ⏳ 待完成的功能

### 2. 版本按钮消失问题

**问题**: 套牌页面的卡牌详情第一次打开会出现切换版本按钮，第二次打开就消失了

**状态**: 需要进一步调查

**可能原因**:
- `printings` 列表每次创建 DialogFragment 时都会重置
- 异步加载可能未完成

**待实现**:
- 保存印刷版本到内存缓存
- 或从服务器加载时保存 `oracleId` 到数据库

---

### 3. Scryfall 备用图片支持

**服务器改动**: 服务端已添加 Scryfall 图片 URL 作为备用

**待实现**:
1. 更新 `ImageUris` 数据结构（已完成）
   - 添加 `scryfallSmall`, `scryfallNormal`, `scryfallLarge`, `scryfallPng` 字段

2. 创建图片加载工具类（部分完成）
   - 支持自动回退到 Scryfall
   - 需要添加资源文件（card_placeholder, card_error）

3. 更新 CardInfo 传递 ImageUris 对象
   - 需要修改 ServerMapper
   - 需要修改 CardInfo 领域模型

**建议优先级**: 中等（不影响核心功能）

---

## 📊 测试状态

- ✅ 编译成功
- ✅ 安装成功
- ⏳ 用户测试中

请测试：
1. 打开多张卡牌，检查是否还会卡顿
2. 检查版本按钮是否正常显示
3. 检查图片是否正常加载

---

**提交状态**: 未提交（等待测试验证）
