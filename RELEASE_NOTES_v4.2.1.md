# v4.2.1 发布说明

## 🎉 版本信息
- **版本号**: v4.2.1
- **版本代码**: 79
- **发布日期**: 2026-02-06
- **分支**: dev/v4.2.0

---

## ✨ 新功能

### 1. 深色模式（Dark Mode）
- 支持三种主题模式：
  - 🌙 跟随系统
  - ☀️ 浅色模式
  - 🌃 深色模式
- 新增设置页面，可自由切换主题
- 所有界面完整支持深色模式，包括：
  - 主界面（赛事列表、收藏列表）
  - 赛事详情页
  - 套牌详情页
  - 套牌分析页
  - 搜索页
  - 设置页

**使用方法**: 设置 → 主题 → 选择模式

---

### 2. 手势操作 - 滑动删除赛事

在赛事列表页面，可以通过手势快速删除赛事：

**操作方式**:
- 向左滑动赛事项 → 显示红色删除背景
- 向右滑动赛事项 → 显示红色删除背景
- 松手 → 弹出确认对话框
- 确认 → 删除赛事及其所有套牌数据

**优化点**:
- 收藏页面禁用滑动手势，确保流畅滚动
- 红色背景视觉反馈清晰
- 防止误操作的确认对话框

---

### 3. 收藏功能完善

#### 3.1 收藏列表红心可点击
- 在"我的收藏"页面，可以直接点击红心图标取消收藏
- 点击后显示 Toast 提示
- 自动刷新列表

#### 3.2 套牌详情页红心状态显示
- **未收藏**: 显示空心红心 ⚪
- **已收藏**: 显示实心红心 🔴
- 图标状态准确反映数据库中的收藏状态

#### 3.3 红心状态自动同步
- 从收藏列表进入详情页 → 红心显示为实心
- 从赛事列表进入详情页 → 红心显示为空心（除非已收藏）
- 点击红心切换收藏 → 图标立即更新
- 返回后再次进入 → 红心状态保持正确

---

## 🔧 技术改进

### 代码优化
1. **MainViewModel.toggleFavorite()**
   - 改为 suspend 函数
   - 返回 Boolean 值表示新的收藏状态
   - 便于调用者获取反馈

2. **DecklistAdapter 增强**
   - 添加收藏状态显示逻辑
   - 支持红心点击事件回调
   - 异步加载收藏状态

3. **DeckDetailActivity 生命周期**
   - 添加 onStart() 和 onResume()
   - 自动刷新收藏状态
   - 确保图标与数据库同步

4. **图标资源修复**
   - 修复 ic_favorite_border.xml 为真正的空心图标
   - ic_favorite_filled.xml 保持实心图标
   - 视觉区分更明显

### 新增文件
- `app/src/main/res/values-night/colors.xml` - 深色模式颜色
- `app/src/main/res/values-night/themes.xml` - 深色模式主题
- `app/src/main/java/com/mtgo/decklistmanager/ui/settings/SettingsActivity.kt` - 设置页
- `app/src/main/res/layout/activity_settings.xml` - 设置页布局
- `app/src/main/res/xml/settings_preferences.xml` - 设置选项配置
- `TEST_CHECKLIST_v4.2.1.md` - 测试清单

### 修改文件
- `MainActivity.kt` - 添加设置菜单、手势处理
- `DecklistAdapter.kt` - 收藏状态显示和点击
- `MainViewModel.kt` - toggleFavorite() 改为 suspend
- `DeckDetailActivity.kt` - 生命周期刷新
- `item_decklist.xml` - 添加红心图标
- `app/build.gradle` - 版本更新、依赖添加
- `strings.xml` - 设置相关字符串
- `main_menu.xml` - 设置菜单项
- `AndroidManifest.xml` - 注册 SettingsActivity

---

## 🐛 修复的问题

1. **收藏页面无法滚动**
   - 原因: ItemTouchHelper 拦截触摸事件
   - 修复: 在收藏页面禁用滑动手势

2. **红心图标不变化**
   - 原因: ic_favorite_border.xml 和 ic_favorite_filled.xml 内容相同
   - 修复: 创建真正的空心图标

3. **套牌详情页红心状态不同步**
   - 原因: 未在生命周期中刷新状态
   - 修复: 添加 onStart() 和 onResume()

4. **收藏列表红心无法点击**
   - 原因: 缺少点击事件处理
   - 修复: 添加 onFavoriteClick 回调

---

## 📱 系统要求

- **最低 Android 版本**: API 21 (Android 5.0)
- **目标 Android 版本**: API 34 (Android 14)
- **编译 SDK**: 34

---

## 📦 依赖更新

新增依赖:
```gradle
implementation "androidx.preference:preference-ktx:1.2.1"
```

---

## 🔄 升级说明

从 v4.2.0 升级到 v4.2.1:

1. **数据兼容**: ✅ 完全兼容，无需数据库迁移
2. **设置重置**: ✅ 不需要，新增设置项有默认值
3. **用户操作**: 无需操作，应用会自动使用跟随系统主题

---

## 🎯 测试状态

| 功能模块 | 测试状态 | 备注 |
|---------|---------|------|
| 深色模式 | ✅ 已测试 | 所有页面正常 |
| 滑动删除赛事 | ✅ 已测试 | 赛事列表正常 |
| 收藏页面滚动 | ✅ 已测试 | 流畅无问题 |
| 收藏列表红心点击 | ✅ 已测试 | 点击正常切换 |
| 套牌详情页红心显示 | ✅ 已测试 | 空心/实心正确 |
| 红心状态同步 | ✅ 已测试 | 页面切换正常 |

---

## 📸 功能截图

### 深色模式
- 浅色模式主界面
- 深色模式主界面
- 设置页面

### 手势操作
- 滑动删除赛事（左滑/右滑）
- 删除确认对话框

### 收藏功能
- 收藏列表红心图标
- 套牌详情页红心状态（空心/实心）

---

## 🚀 下一步计划

### v4.2.2 (可选)
- [ ] 长按卡片快速预览
- [ ] 性能优化（列表滚动、图片加载）
- [ ] 搜索防抖功能

### 未来版本
- [ ] 更多手势操作
- [ ] 卡牌收藏夹分类
- [ ] 套牌对比功能
- [ ] 云同步功能

---

## 📝 更新日志

### v4.2.1 (2026-02-06)
- ✨ 新增深色模式支持
- ✨ 新增滑动删除赛事功能
- 🐛 修复收藏页面滚动问题
- 🐛 修复红心图标显示问题
- 🐛 修复红心状态同步问题
- 🔧 优化收藏功能的用户体验

---

## 👥 贡献者

- 开发: Claude Code
- 测试: [待填写]
- 设计: Material Design 3

---

## 📄 许可证

本软件为开源项目，遵循 [LICENSE] 许可证。

---

**感谢使用 MTGO Decklist Manager! 🎴**
